========================================
設備日常点検記録アプリケーション 仕様書
========================================

1. 概要
--------
本仕様書は、工場や施設における設備の日常点検業務を支援するコンソールアプリケーションの機能仕様を記述するものである。本アプリケーションは、点検担当者が設備の状態を簡易に記録し、日付ごとに整理されたCSV形式のファイルとして保存することを目的としている。

想定される利用者は、製造業の現場作業者、設備管理担当者、保守点検担当者などであり、日々の定常業務における設備点検記録の効率化と電子化を支援する。特に、紙ベースの点検記録簿からの移行や、簡易なデジタル記録手段を求める現場での利用を想定している。

本システムは単独で動作するコンソールアプリケーションであり、データベースや外部システムとの連携は行わない。点検結果は全てローカルのCSVファイルに保存される。


2. 前提条件
-----------
本アプリケーションの動作には以下の環境が必要である。

・実行環境：Microsoft .NET 8.0 SDK以上がインストールされていること
・オペレーティングシステム：.NET 8.0が動作可能なOS（Windows、macOS、Linux）
・開発言語：C#（.NET 8.0対応）
・文字コード：UTF-8を標準とする
・ファイルシステム：アプリケーション実行ディレクトリに対する読み書き権限が必要
・実行方法：コマンドラインまたはターミナルからの実行を前提とする

本アプリケーションは外部ライブラリへの依存がなく、.NET標準ライブラリのみを使用している。そのため、追加のパッケージインストールは不要である。


3. 用語定義
-----------
本仕様書内で使用する主な用語について以下に定義する。

・設備：点検対象となる工場や施設内の機械、装置、システムを指す。例としてポンプ、コンプレッサー、ボイラー、配管システムなどが含まれる。

・点検結果：設備の状態を示す判定結果であり、「OK」（正常）または「NG」（異常・要対応）の二値で表される。

・コメント：点検結果に付随する補足情報であり、異常の詳細、気付き事項、対応内容などを自由記述形式で記録する。

・CSV形式：カンマ区切り形式のテキストファイルであり、表計算ソフトウェアやデータベースでの取り込みが容易な汎用データ形式である。

・日次ファイル：点検記録を日付単位で分割保存するファイル形式であり、ファイル名に日付が含まれる。


4. システム構成
---------------
本アプリケーションは単一のC#プログラムファイル（Program.cs）から構成されるシンプルな構造を持つ。外部モジュールやライブラリへの依存はなく、.NET標準ライブラリのみを使用している。

主要な構成要素は以下の通りである。

・名前空間：InspectionApp
・クラス：Program（単一のメインクラス）
・エントリーポイント：Main メソッド

アプリケーションは対話型のコンソールインターフェースを提供し、ユーザーからの入力を順次受け付けて処理する。処理結果は実行ディレクトリ内のCSVファイルに追記される形で保存される。

データの永続化はファイルシステムを利用し、データベースやネットワーク接続は使用しない。これにより、オフライン環境での利用や、システム導入の容易さを実現している。


5. 機能概要
-----------
本アプリケーションが提供する主な機能は以下の通りである。

・設備選択機能：事前に定義された設備リストから点検対象を選択する機能、または任意の設備名を手入力する機能

・点検結果入力機能：設備の状態を「OK」または「NG」で判定し記録する機能

・コメント入力機能：点検結果に対する補足説明や所見を任意で記録する機能

・CSV保存機能：入力された点検記録を日付別のCSVファイルに自動的に保存する機能

・連続記録機能：複数の設備の点検を連続して記録できる機能

・ファイル自動管理機能：日付が変わると自動的に新しいCSVファイルを作成する機能

・データエスケープ機能：CSVファイル内でカンマや引用符などの特殊文字を適切に処理する機能


6. 機能詳細
-----------

6-1. アプリケーション起動と全体制御
-----------------------------------
本機能は、アプリケーションの起動から終了までの全体的な流れを制御する。

処理の流れは以下の通りである。

1. アプリケーションが起動すると、タイトル「設備日常点検記録アプリ」が表示される
2. 点検記録の入力プロセスがループ形式で開始される
3. 各点検記録の入力が完了するたびに、続けて記録を行うかの確認メッセージが表示される
4. ユーザーが「y」（yes）を入力すると次の点検記録入力に進み、「n」（no）を入力するとアプリケーションが終了する
5. 終了時には「アプリを終了します。お疲れ様でした。」というメッセージが表示される

入力情報：ユーザーからの継続確認応答（y/n）

出力結果：画面への案内メッセージ、および点検記録の保存完了通知

正常時の挙動：ユーザーが終了を選択するまで、点検記録を連続して入力できる状態が維持される

異常時の挙動：標準入力がEOF（End of File）を検知した場合は、自動的にアプリケーションを終了する。EOFシグナルの入力方法はOSに依存し、Unix/Linux/macOSではCtrl+D、WindowsではCtrl+Zとなる


6-2. 設備選択機能
-----------------
点検対象となる設備を選択または入力する機能である。

処理の流れは以下の通りである。

1. 事前に定義された8種類の設備リストが番号付きで画面に表示される
2. リストの最後に「その他（手入力）」という選択肢が追加表示される
3. ユーザーは番号を入力して設備を選択する
4. 1から8の番号を選択した場合、対応する設備名が自動的に確定される
5. 9（その他）を選択した場合、設備名の手入力を求める画面に遷移する
6. 手入力の場合、空白のみの入力は受け付けず、有効な設備名の入力を求める

入力情報：設備選択番号（1～9の整数）、または手入力の設備名

出力結果：選択または入力された設備名

正常時の挙動：有効な番号または設備名が入力されると、その設備名が確定され次の処理に進む

異常時の挙動：範囲外の番号や無効な入力に対してはエラーメッセージを表示し、再入力を促す。EOFを検知した場合はnullを返してアプリケーションを終了する

設備リストに登録されているデフォルトの設備は以下の通りである。
・ポンプA
・ポンプB
・コンプレッサー
・ボイラー
・冷却塔
・電気盤
・配管システム
・換気扇


6-3. 点検結果入力機能
---------------------
設備の点検結果を「OK」または「NG」の二値で記録する機能である。

処理の流れは以下の通りである。

1. 「点検結果を入力してください (OK/NG):」というプロンプトが表示される
2. ユーザーは「OK」または「NG」のいずれかを入力する
3. 入力された文字列は大文字に自動変換されるため、小文字での入力も受け付けられる
4. 有効な入力が確認されると、その結果が確定され次の処理に進む

入力情報：点検結果（OK または NG）

出力結果：確定した点検結果（OK または NG）

正常時の挙動：「OK」または「NG」のいずれかが入力されると、その結果が記録される

異常時の挙動：「OK」「NG」以外の文字列が入力された場合は、「OKまたはNGを入力してください」というエラーメッセージを表示し、再入力を促す。EOFを検知した場合はnullを返してアプリケーションを終了する


6-4. コメント入力機能
---------------------
点検結果に対する補足情報を任意で記録する機能である。

処理の流れは以下の通りである。

1. 「コメントを入力してください（Enter キーでスキップ）:」というプロンプトが表示される
2. ユーザーはコメントを入力するか、Enterキーのみを押してスキップできる
3. 入力された文字列の前後の空白は自動的に除去される
4. 何も入力されずにEnterキーが押された場合、コメントは「なし」として記録される

入力情報：コメント（任意の文字列）、または空入力

出力結果：入力されたコメント、または「なし」

正常時の挙動：入力されたコメントがそのまま記録される。空入力の場合は「なし」が記録される

異常時の挙動：コメント入力時にEOF（入力ストリームの終了）が発生した場合でもアプリケーションは終了せず、入力なしとみなしてコメント「なし」として記録される。それ以外に本機能で特に異常処理は行わない


6-5. CSV保存機能
-----------------
入力された点検記録を日付別のCSVファイルに保存する機能である。

処理の流れは以下の通りである。

1. 現在の日時が取得され、年月日と時分の情報が記録される
2. ファイル名は「inspection_results_YYYYMMDD.csv」の形式で生成される（例：inspection_results_20260213.csv）
3. 該当する日付のファイルが既に存在する場合はそのファイルを開き、存在しない場合は新規作成する
4. ファイルが新規作成の場合のみ、ヘッダー行「日時,設備名,点検結果,コメント」が書き込まれる
5. 点検記録が1行のCSV形式データとしてファイルの末尾に追記される
6. 設備名とコメントにカンマや引用符が含まれる場合は、適切にエスケープ処理が施される

入力情報：
・記録日時（yyyy-MM-dd HH:mm形式）
・設備名
・点検結果（OK または NG）
・コメント

出力結果：CSVファイルへの書き込み成功、および画面への保存完了メッセージ

正常時の挙動：点検記録が指定された日付のCSVファイルに追記され、「✓ 点検記録を保存しました。」というメッセージが表示される

異常時の挙動：ファイル書き込み権限がない場合や、ディスク容量不足の場合は例外が発生し、アプリケーションが異常終了する。現在のコードでは明示的なエラーハンドリングは実装されていない

保存されるCSVファイルの形式：
・文字コード：UTF-8
・区切り文字：カンマ
・ヘッダー行：初回書き込み時のみ出力される
・データ形式：日時,設備名,点検結果,コメント


6-6. CSVエスケープ処理機能
---------------------------
CSVファイルにおいて特殊な意味を持つ文字を適切に処理する機能である。

処理の流れは以下の通りである。

1. 設備名またはコメントに対してエスケープ処理が実行される
2. 文字列にカンマ、ダブルクォート、改行文字が含まれているかを検査する
3. これらの文字が含まれている場合、以下の処理を行う
   ・既存のダブルクォートを2つのダブルクォートに置換する
   ・文字列全体をダブルクォートで囲む
4. 特殊文字が含まれていない場合は、元の文字列をそのまま使用する

入力情報：エスケープ対象の文字列（設備名またはコメント）

出力結果：CSV形式として適切にエスケープされた文字列

正常時の挙動：全ての特殊文字が適切にエスケープされ、CSVファイルとして正しく読み込める形式で保存される

異常時の挙動：本機能では特に異常処理は発生しない


6-7. 複数プロセス対応機能
-------------------------
複数のアプリケーションインスタンスが同時に起動された場合でも、CSVファイルへの書き込みの整合性を保つための機能である。

処理の流れは以下の通りである。

1. ファイルを開く際に、FileMode.OpenOrCreate（存在すれば開く、存在しなければ作成）を指定する
2. FileAccess.Write（書き込み専用）とFileShare.Read（他プロセスからの読み込みを許可）を指定する
3. ファイルストリームを末尾までシークしてから書き込みを行う
4. ファイルサイズが0の場合のみヘッダーを書き込むことで、ヘッダーの重複を防ぐ

入力情報：特になし（内部処理として機能する）

出力結果：単一プロセス（または単一インスタンス）による追記書き込み時の記録整合性の確保（ヘッダーの重複防止、末尾への追記）

正常時の挙動：本アプリケーションを単一インスタンスで実行している場合、記録の欠落や重複が発生することなく、既存ファイルの末尾に対して安全に追記される。他プロセスからの読み取りは許可される。

異常時の挙動：複数のアプリケーションインスタンスが同一のCSVファイルに対して同時に書き込みを行おうとした場合、FileShare.Read により書き込みオープンが共有違反となり、例外が発生して書き込みに失敗する可能性がある。本仕様では厳密な排他制御や同時書き込みの完全な整合性はサポートしないため、同時起動・同時書き込みは想定外の利用形態とし、必要な場合は別途排他制御やリトライ機構を実装した上で利用する。


7. データ仕様
-------------

7-1. 設備リストデータ
---------------------
アプリケーション内で事前定義されている点検対象設備のマスターデータである。

・データ型：文字列配列（string[]）
・定義場所：Program クラスの静的読み取り専用フィールド
・項目数：8項目（デフォルト状態）
・用途：設備選択時の選択肢として画面に表示される
・拡張方法：Program.cs のソースコードを編集し、配列に要素を追加することで拡張可能


7-2. 点検記録データ
-------------------
1回の点検記録として保存される情報の集合である。

・記録日時：点検が記録された日時を示す。形式は「yyyy-MM-dd HH:mm」（例：2026-02-13 10:30）
・設備名：点検対象の設備の名称。最大長の制限はないが、CSVの可読性を考慮して適度な長さが望ましい
・点検結果：設備の状態を示す判定結果。取りうる値は「OK」または「NG」の2種類のみ
・コメント：点検結果に対する補足説明。最大長の制限はない。入力がない場合は「なし」が記録される


7-3. CSVファイルデータ
----------------------
点検記録が保存されるCSVファイルの構造仕様である。

・ファイル名形式：inspection_results_YYYYMMDD.csv
・ファイル名例：inspection_results_20260213.csv
・保存場所：アプリケーション実行ディレクトリ
・文字コード：UTF-8
・改行コード：環境依存（実行OSの標準改行コードが使用される）
・ヘッダー行：日時,設備名,点検結果,コメント
・データ行：各点検記録が1行ずつ記録される
・エスケープルール：フィールドにカンマ、ダブルクォート、改行が含まれる場合、フィールド全体をダブルクォートで囲み、ダブルクォート自体は2つ重ねてエスケープする


7-4. 入力データの制約
---------------------
ユーザー入力に関する制約事項である。

・設備選択番号：1から9の整数のみ有効。範囲外の値は受け付けない
・手入力設備名：空白のみの入力は受け付けない。少なくとも1文字以上の有効な文字が必要
・点検結果：「OK」または「NG」のみ受け付ける。大文字小文字は区別しない（自動的に大文字に変換される）
・コメント：制約なし。任意の文字列を入力可能
・継続確認応答：「y」、「yes」で継続、「n」その他の値で終了


========================================
以上
========================================
